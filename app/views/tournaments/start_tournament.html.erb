<% provide(:title, "#{@tournament.name}") %>

<% @tournament.start_tournament %>

<div class="round_container">

<%= render 'layouts/breadcrumbs' %>
    
<div>
    <h2 class="title"><%= @tournament.name %></h2>
</div>

<ul class="detail">
    <li><%= pluralize(@tournament.players.count, "player") %></li>
    <li id="tournament-winner">
        <% temp_id = @tournament.winner_id %>
        <% if temp_id != 0 %>
            <% p = @tournament.winner %>
            Winner: <a href="/players/<%= p.id %>"><%= p.full_name %></a>
        <% else %>
            There is no winner yet.
        <% end %>
    </li>
</ul>
<div class="divider"></div>

<% match_number = 1 %>
<% cur_round = 0 %>
<% new_round = false %>

<% @matches.each do |m| %>
    <% if cur_round != m.round %>
        <% cur_round = m.round %>
        <% if cur_round == 1 %>
            <div class="round round-<%= 1 %>">
        <% else %>
            </div>
            <div class="round round-<%= cur_round %>">
        <% end %>

    <% end %>
    
    <% if cur_round == 1 && m.player1_id == 0 && m.player2_id == 0 %>
    <div class="matches-row non-match-row">
    <% else %>
    <div class="matches-row">
    <% end %>

        <ul class="matches-list">
            <% if cur_round == 1 && m.player1_id == 0 && m.player2_id == 0 %>
            <div id="match-<%= m.id %>" class="match non-match">
            <% else %>
            <div id="match-<%= m.id %>" class="match">
            <% end %>
                <% winner_id = m.winner_id %>

                <% p1 = m.player1 if m.player1_id != 0 %>
                <% p2 = m.player2 if m.player2_id != 0 %>

                <% if p1 && p2 && winner_id != 0 %>

                    <% if winner_id == p1.id %>
                        <% p1_is_winner = true %>
                    <% else %>
                        <% p2_is_winner = true %>
                    <% end %>
                <% end %>


                <li class="<% if winner_id != 0 %>
                                    <%= p1_is_winner ? "match-winner" : "match-loser" %>
                               <% end %>">
                    <% if winner_id != 0 %>
                        <%= gravatar_for p1, size: 30 %>
                        <%= p1 ? "#{p1.first_name} #{p1.last_name}" : ""  %>
                    <% end %>
                    <% if winner_id == 0 && p1 %>
                        <button class="winner_btn tournament_match_winner_btn" data-match-id="<%= m.id %>" data-player-id="<%= p1.id if p1%>" data-round-id="<%= m.round %>"
                                data-match-number="<%= match_number %>" data-player-number="1"><%= gravatar_for p1, size: 30 %><%= p1 ? "#{p1.first_name} #{p1.last_name}" : "" %>
                            </button></li>
                    <% end %>
                    <li class="<% if winner_id != 0 %>
                                    <%= p2_is_winner ? "match-winner" : "match-loser" %>
                               <% end %>">
                        <% if winner_id != 0 %>
                            <%= gravatar_for p2, size: 30 %>
                            <%= p2 ? "#{p2.first_name} #{p2.last_name}" : ""  %>
                        <% end %>
                        <% if winner_id == 0 && p2 %>
                            <button class="winner_btn tournament_match_winner_btn" data-match-id="<%= m.id %>" data-player-id="<%= p2.id if p2%>" data-round-id="<%= m.round %>"
                                    data-match-number="<%= match_number %>" data-player-number="2"><%= gravatar_for p2, size: 30 %><%= p2 ? "#{p2.first_name} #{p2.last_name}" : ""  %></button>
                        <% end %>

                        <% match_number = match_number + 1 %>


                        </div>
                    </li>

        </ul>
        <div class="match-border-filler"></div>
        <div class="match-border"></div>

    </div>


<% end %>

</div>

</div>
<div id="filler"></div>

